////////////////////////////////////////////////////////////
// Phase 3: WF population cage (FINAL, CORRECT)
////////////////////////////////////////////////////////////

initialize() {

    defineConstant("BURN_IN_FILE",
        "inversion_polymorphic_job=379_rep=8591182220835234285_freq=0.0803.txt");

    defineConstant("K_cage", 500);
    defineConstant("N_low", 4);
    defineConstant("N_multi", 20);
    defineConstant("Cage_gen", 100);

    defineConstant("L", 23e6);
    defineConstant("Rec_rate", 2.4e-8);

    initializeSLiMModelType("WF");

    initializeMutationType("m1", 0.5, "f", 0.0);
    initializeMutationType("m2", 0.0, "g", -0.001, 0.33);
    initializeMutationType("m3", 0.5, "f", 0.0);

    m1.convertToSubstitution = F;
    m2.convertToSubstitution = F;
    m3.convertToSubstitution = F;

    initializeGenomicElementType("g1", c(m1, m2), c(0.26, 0.74));
    initializeGenomicElement(g1, 0, L - 1);

    initializeMutationRate(0.0);
    initializeRecombinationRate(Rec_rate);
}

////////////////////////////////////////////////////////////
// GEN 1: load burn-in and create cages
////////////////////////////////////////////////////////////

1 early() {

    sim.readFromPopulationFile(BURN_IN_FILE);

    // identify heterozygotes
    hets = p1.individuals[
        p1.individuals.countOfMutationsOfType(m3) == 1
    ];

    if (size(hets) < (N_low + N_multi))
        stop("Not enough heterozygotes");

    // ---- split founders directly from burn-in ----
    sim.addSubpopSplit("p2", N_low, p1);    // LF founders
    sim.addSubpopSplit("p3", N_multi, p1);  // MF founders

    // ---- expand founders into cages ----
    sim.addSubpopSplit("p4", K_cage, p2);   // LF cage
    sim.addSubpopSplit("p5", K_cage, p3);   // MF cage

    // ---- cleanup ----
    p1.setSubpopulationSize(0);
    p2.setSubpopulationSize(0);
    p3.setSubpopulationSize(0);

    defineConstant("START_GEN", sim.cycle);
}

////////////////////////////////////////////////////////////
// STOP
////////////////////////////////////////////////////////////

(START_GEN + Cage_gen) late() {
    sim.simulationFinished();
}
